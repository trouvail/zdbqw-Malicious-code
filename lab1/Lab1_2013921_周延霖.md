# 恶意代码分析与防治技术实验报告——lab1

> **学号：2013921  
姓名：周延霖  
专业：信息安全**






### 实验环境
---

由于本人的本机是`macOS Montery 12.4`，所以在本机上对`Windows`的`.exe`文件的漏洞分析较为困难，于是我选择用`VMware Fusion`这个虚拟机管理软件来运行`Windows XP`操作系统来完成本次对四种恶意代码分析的实验（但对于在[`VirusTotal`](https://www.VirusTotal.com/)上网站进行的分析是直接从本机上上传的）


### 实验工具
---
由于本次是第一次实验，所以用到的分析工具都较为基础，并且用到的工具较少，现将其列举如下：
- `PEview`
- `UPX`
- `Resource Hacker`
- `PEiD`


### 实验内容
---

#### *lab1-1*

##### 这个实验使用`Lab01-01.exe`和`Lab01-01.dll`文件，使用本章描述的工具和技术来获取关于这些文件的信息.

>Q1.将文件上传至[`VirusTotal`](https://www.VirusTotal.com/)进行分析并查看报告。文件匹配到了已有的反病毒软件特征吗？  



上传可执行文件后的结果如下图所示：

![1-1-1](https://i.imgtg.com/2022/10/06/p1vOb.png)

可以看到有52个安全供应商和1个沙盒将其标记为恶意程序

>Q2.这些文件是什么时候编译的？

使用PEview工具打开`.exe`和`.dll`文件。对于每个文件，观察IMAGE_NT_HEADERS->IMAGE_ FILE_ HEADER->Time Date Stamp字段，这个字段显示了文件的编译时间，如以下两张图片所示：


![1-1-2](https://i.imgtg.com/2022/10/06/p7xWa.png)


![1-1-3](https://i.imgtg.com/2022/10/06/p7zyS.png)

这两个文件都是在2010年12月19日被编译的，两者编译时间在1分钟以内。这证实了认为这两个文件同属一个恶意代码包的怀疑。事实上，编译时间非常接近说明是由同一作者在同时间创建了这些文件。所以这些文件是关联的，因为它们的编译时间与被发现的位置。这个.exe文件可能是用来使用或安装.dll文件的，因为DLL动态链接库文件无法运行自己。


>Q3. 这两个文件中是否存在迹象说明它们是否被加壳或混淆了？如果是，这些迹象在哪里？

这两个文件的导入表数量都很少，也都有着适当大小的良好组织的文件节，如下图所示：

![1-1-4](https://i.imgtg.com/2022/10/06/p7iaC.png)

PEiD工具标记为未加壳的代码，并是由`Microsoft Visual C++`编译的，如下图所示：

![1-1-5](https://i.imgtg.com/2022/10/06/p7neL.png)

这说明，这些文件并没有被加壳。事实上，文件只有少量的导入表说明它们很可能只是一些小程序但是该DLL文件并没有导出表，这是不正常的，但并不是被加壳的迹象。


>Q4. 是否有导入函数显示出了这个恶意代码是做什么的？如果是，是哪些导入函数？

对`.exe`文件的导入表与字符串列表进行查看。从`msvcrt.dll`导入的通常是被每一个可执行文件都包含的，因为它们是作为包装代码被编译器加入可执行文件的，当查看从`kernel32.dll`导入的函数时，可以看到一些打开与操作文件的函数，以及`FindFirstFile`和`FindNextFile`函数。如下图所示：

![1-1-6](https://i.imgtg.com/2022/10/06/p7FsN.png)



这些导入函数表明恶意代码会对文件系统进行搜索以及打开和修改文件。还不能确定恶意代码在搜索什么文件，但`.exe`字符串说明，恶意代码正在寻找搜索目标系统上的可执行文件。

>Q5. 是否有任何其他文件或基于主机的迹象，让你可以在受感染系统上查找？

可以发现`C:\windows\System32\Kernel32.dll`和`C:Windows\System32\kerne132.dll`（字母l和数字1的区别），如下图所示：

![1-1-7](https://i.imgtg.com/2022/10/06/p71Gi.png)


`kerne132.dll`文件显然是想将自己冒充混淆为`Windows`的系统文件`kernel32.dll`。因此，`kernel/32.dll`可以作为一个基于主机的迹象来发现恶意代码感染，并且是分析恶意代码所需要关注的一个线索。

>Q6. 是否有基于网络的迹象，可以用来发现受感染机器上的这个恶意代码？

查看`Lab01-01.dll`的导入表和字符串列表。其中导入了`WS2_32.dll`的一些函数。因为这些导入函数是按照序号进行导入的，现在还不知道导入的到底是哪些函数。从`kernel32.dll`导入了两个有趣的函数：`Createprocess`和`Sleep`，如下图所示：

![1-1-8](https://i.imgtg.com/2022/10/06/p77IX.png)


这两个函数普遍在后门程序中使用，这些函数在与`exec`与`sleep`字符串结合使用时，需要特别的关注。`.dll`文件中包含一个私有子网IP地址`127.26.152.13`的宇符串。这个地址预示着这个程序是为了教学目的而不是恶意目的而编制的，如果这是真正的恶意代码，这个地址应该是可路由的公网地址，它会是一个很好的基于网络的恶意代码感染迹象，可以用来识别这个恶意代码。

>Q7. 你猜这些文件的目的是什么？

`exec`字符串可能是通过网络来给后门程序传送命令，让它通过`createprocess`函数运行一个程序的。`sleep`字符串可能用于命令后门程序进入休眠模式。`.dll`文件可能是一个后门。而`.exe`文件是用来安装与运行`DLL`文件的。



#### *lab1-2*

##### 分析`Lab01-02.exe`文件.


>Q1.将`Lab01-02.exe`文件上传至[`VirusTotal`](https://www.VirusTotal.com/)进行分析并查看报告。文件匹配到了己有的反病毒软件特征吗？


上传可执行文件后的结果如下图所示：

![1-2-1](https://i.imgtg.com/2022/10/06/p1AZ6.png)

可以看到有56个安全供应商将其标记为恶意程序





>Q2. 是否有这个文件被加壳或混淆的任何迹象？如果是这样，这些迹象是什么？如果该文件被加壳，请进行脱壳，如果可能的话。


使用`PEview`工具打开这个文件，几个迹象可以表明这个文件是被加壳的。其中最明显的迹象是名为UPX0、UPX1和UPX2的节，明显是由UPX进行加壳后恶意代码程序的节名称，如下图所示：

![1-2-2](https://i.imgtg.com/2022/10/06/pNQxx.png)


所以使用PEiD工具，来确认文件的加壳类型，在确定出加壳类型之后，从[`upx下载地址`](https://upx.sourceforge.net/)下载`UPX`工具，并运行以下命令对其进行脱壳：



> upx -o newFilename -d originalFilename

`-d`选项表示对文件进行脱壳，`-o`选项指定了输出文件名。




>Q3. 有没有任何导入函数能够暗示出这个程序的功能？如果是，是哪些导入函数，它们会告诉你什么？

脱壳之后，审查脱壳恶意代码的导入表和字符串列表，如下图所示：

![1-2-3](https://i.imgtg.com/2022/10/06/pNSpj.png)


这个恶意代码的导入函数都是从`kernel32.dll`和`msvert.dll`，而这些函数几乎被每个程序都导入，所以它们能够显示关于这个恶意代码的信息很少。从`wininet.dll`导入的函数显示这个恶意代码会进行联网操作 (`Internetopen`和`InternetOpenURL`），从`advapi32.dll`的导入函数(`Createservice`）显示这个代码会创建一个服务。

>Q4. 哪些基于主机或基于网络的迹象可以被用来确定被这个恶意代码所感染的机器？

在检查字符串列表时，我们看到`www.malwareanalysisbook.com`，这可能是`InterneOpenURL`函数中所打开的`URL`；以及`Malservice字符串，这可能是所创建的服务名称。虽然不能肯定这个程序会做什么，但这些线索，能够在网络上和系统里来搜索这个恶意代码。



#### *lab1-3*

##### 分析`Lab01-03.exe`文件.

>Q1. 将`Lab01-03.exe`文件上传至[`VirusTotal`](https://www.VirusTotal.com/)进行分析并查看报告。文件匹配到了已有的反病毒软件特征吗？




上传可执行文件后的结果如下图所示：

![1-3-1](https://i.imgtg.com/2022/10/06/p1rTF.png)

可以看到有65个安全供应商将其标记为恶意程序

>Q2. 是否有这个文件被加壳或混淆的任何迹象？如果是这样，这些迹象是什么？如果该文件被加壳，请进行脱壳，如果可能的话。


这个文件是加壳的，但以我现在的技术还没有办法对其进行脱壳操作，当使用`PEview`工具打开文件时，可以观察到一些迹象表明这个文件是加壳的，如下图所示：


![1-3-2](https://i.imgtg.com/2022/10/06/pNjXM.png)


首先是文件的节并没有名字，首节的虛拟大小为`0x3000`，但原始数据大小却为0。接下来运行`PEiD`工具进行确认，它将加壳器标识为`FSG 1.0- > dulek /xt`，如下图所示：


![1-3-3](https://i.imgtg.com/2022/10/06/pN9Hr.png)


为了确认这个文件是被加壳的，搜索导入表却没有发现。一个没有导入表的可执行文件是极为罕见的，没有导入表这个奇怪现象说明应该尝试另一种工具，因为PEview无法正常处理这个文件。


然后使用`Dependency Walker`打开这个文件，看到它拥有一个导入表，但其中只有两个函数：`LoadLibrary`和`GetProcAddress`。加壳文件往往只有这两个导入函数，这进一步表明了这个文件是被加过壳的。


>Q3. 有没有任何导入函数能够暗示出这个程序的功能？如果是，是哪些导入函数，它们会告诉你什么？

由于Q2中的分析，我现在还不能对其进行脱壳处理，所以现在还不能看到它的具体函数。





>Q4. 有哪些基于主机或基于网络的迹象，可以被用来确定被这个恶意代码所感染的机器？

由于Q2中的分析，我现在还不能对其进行脱壳处理，所以现在还不能确定基于主机或基于网络的迹象。



#### *lab1-4*


##### 分析`Lab01-04.exe`文件.



>Q1. 将`Lab01-04.exe`文件上传至[`VirusTotal`](https://www.VirusTotal.com/)进行分析并查看报告。文件匹配到了已有的反病毒软件特征吗？



上传可执行文件后的结果如下图所示：

![1-4-1](https://i.imgtg.com/2022/10/06/p1KcP.png)

可以看到有62个安全供应商和1个沙盒将其标记为恶意程序，对于`Lab01-04.exe`文件，从`VirusTotal.com`得到的结果表明这个程序是与下载器相关的。



>Q2. 是否有这个文件被加壳或混淆的任何迹象？如果是这样，这些迹象是什么？如果该文件被加壳，请进行脱壳，如果可能的话。

`PEview`没有显示迹象表明这个文件是加壳或是混淆的。

>Q3. 这个文件是什么时候被编译的？

根据文件头，这个文件是在2019年8月编译的，如下图所示：

![1-4-2](https://i.imgtg.com/2022/10/06/peaHl.png)


显然，通过了解到这个书的发布时间，这个编译时间是伪造的，所以还不能确定这个文件到底是什么时候被编译的。

>Q4. 有没有任何导入函数能够暗示出这个程序的功能？如果是，是哪些导入函数，它们会告诉你什么？

导入函数表如下图所示：

![1-4-3](https://i.imgtg.com/2022/10/06/pe5zB.png)



从`advapi32.dll`导入的函数可以看到，程序做了一些与权限有关的事情。可以假设它试图访问使用了特殊权限进行保护的文件。从`kernel32.dll`的导入函数可以看出这个程序从资源节中装载数据 (`LoadResource`、`FindResource`和`SizeofResource`），并写一个文件到磁盘上(`CreateFile`和`writeFile`），接着执行一个磁盘上的文件(`WinExec`）。可以猜测这个程序将文件写入到了系统目录，因为它调用了`GetwindowsDirectory`函数。


>Q5.有哪些基于主机或基于网络的迹象，可以被用来确定被这个恶意代码所感染的机器？

通过检查字符串，如下图所示：

![1-4-4](https://i.imgtg.com/2022/10/06/peoXg.png)


可以发现`www.malwareanalysisbok.com/updater.exe`字符串，这可能是保存下载恶意代码的网络位置。还可以发现字符串`\system32\wupdmgr.exe`，结合`GetwindowsDirectory`函数调用，这表明恶意代码在`C:\Windows\System32\wupdmgr.exe`位置创建或者修改了一个文件。现在己经有比较充分的证据，知道这个恶意文件下载了一个新的恶意代码。己经知道它是从哪个位置下载恶意代码的，并且可以猜到它会将下载到的恶意代码存储在什么位置。



>Q6.这个文件在资源段中包含一个资源。使用`Resource Hacker`工具来检查资源，然后抽取资源。从资源中你能发现什么吗？

这个恶意代码样本最有趣的就是它的资源节，当使用`Resource Hacker`工具打开这个恶意代码时，只看到了一个资源。`Resource Hacker`工具识别这个资源的类型是二进制，说明是任意的二进制数据，但当查看数据时，它的绝大部分都是无意义的，唯一例外的是字符串`!This program cannot be run in Dos mode`，这个字符串是在所有`PE`文件开始处的`DOS`头部中都会包含的错误消息。于是，可以得出结论，认为这一资源其实是在`Lab01-04.exe`资源节中存储的另一个可执行文件。这种技术在恶意代码中使用得非常普遍。

为了在`Resource Hacker`工具中继续分析这一文件，单击`Action--Save resource as binary file`。在存储完资源后，使用`PEview`来打开文件，分析内嵌的文件。通过查看导入表，可以发现嵌入文件在访问一些网络函数，它调用了`URLDownloadToFile`,一个由恶意下载器普遍使用的函数，它调用了`WinExec`函数，可能执行了下载到的文件。



### 实验心得
---
这一次的实验是恶意代码与防治分析的第一次实验，由于本身参与`CTF`竞赛，所以对这个领域有一定的了解，通过课堂上的理论与实验课的动手相结合，对于恶意代码的检查以及比如`PEview`、`Resource Hacker`、`PEiD`等工具也更加的熟悉，也了解到[`VirusTotal`](https://www.VirusTotal.com/)这个网站的强大之处。
通过本次实验，认识到自己作为一名信息安全专业学生的责任，更加期待本学期后续的实验，最后也希望自己能有更好的发展。




